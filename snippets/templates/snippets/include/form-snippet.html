{% comment %}
	Info:       Snippet form (full)
	Requires:   css and js of static/mdl/*
	Note:       Add External plugins like jquery.ime in including template #}
{% endcomment %}
<link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css" rel="stylesheet" />
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>

<form id="id-snippet-form" method="post" enctype="multipart/form-data" class="a-mdl-form">
	{% csrf_token %} 
	{{ form.non_field_errors }}
	<fieldset>
		<div id="div_id_language" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			<label for="id_language" class="mdl-textfield__label">
				{{form.language.label}}{% if form.language.help_text %} ({{ form.language.help_text|safe }}){% endif %}
			</label>
			<select id="id_language" class="mdl-textfield__input" name="language">
			{% for x,y in form.fields.language.choices %}
    			<option value="{{ x }}"{% if form.language.value == x %} selected=selected{% endif %}>{{ y }}</option>
			{% endfor %}
			</select>
		{% if form.language.errors %}
		    {% for error in form.language.errors %}<span class="error-text">{{ error|escape }}</span>{% endfor %}
		{% endif %}					
		</div>
			
		<div id="div_id_title" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			<label for="id_title" class="mdl-textfield__label">
				{{form.title.label}}{% if form.title.help_text %} ({{ form.title.help_text|safe }}){% endif %}
			</label>
			<input id="id_title" class="mdl-textfield__input" name="title" type="text" autocomplete="off" maxlength="200" value="{{ form.title.value|default_if_none:'' }}" required/>
		{% if form.title.errors %}
		    {% for error in form.title.errors %}<span class="error-text">{{ error|escape }}</span>{% endfor %}
		{% endif %}
		</div>
			
		<div id="div_id_body" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">	
			<label for="id_body" class="mdl-textfield__label">
				{{form.body.label}}{% if form.body.help_text %} ({{ form.body.help_text|safe }}){% endif %}
			</label>
			<textarea id="id_body" class="mdl-textfield__input" name="body" rows="10" required>{{ form.body.value|default_if_none:'' }}</textarea>
		{% if form.body.errors %}
		    {% for error in form.body.errors %}<span class="error-text">{{ error|escape }}</span>{% endfor %}
		{% endif %}					
		</div>

		<div id="div_id_author" class="mdl-textfield">
			<label for="id_author" class="select2__label">
				{{form.author.label}}{% if form.author.help_text %} ({{ form.author.help_text|safe }}){% endif %}
			</label>		
			<select id="id_author" class="js-example-responsive wFull" name="author">
    		{% if form.fields.author.choices %}{% for x,y in form.fields.author.choices %}
    			<option value="{{ x }}"{% if form.author.value == x %} selected=selected{% endif %}>{{ y }}</option>
			{% endfor %}{% endif %}
			</select>				
		{% if form.author.errors %}
		    {% for error in form.author.errors %}<span class="error-text">{{ error|escape }}</span>{% endfor %}
		{% endif %}					
		</div>	
			
		<div id="div_id_tags" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			<label for="id_tags" class="mdl-textfield__label">
				{{form.tags.label}}{% if form.tags.help_text %} ({{ form.tags.help_text|safe }}){% endif %}
			</label>
			<input id="id_tags" class="mdl-textfield__input" name="tags" type="text" maxlength="200" value="{% for taggeditem in form.tags.value %}{{taggeditem.tag.name}}{% if not forloop.last %}, {% endif %}{% endfor %}"/>
		{% if form.tags.errors %}
		    {% for error in form.tags.errors %}<span class="error-text">{{ error|escape }}</span>{% endfor %}
		{% endif %}								
		</div>		
		
	</fieldset>
	<div class="tAr">
		<input class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" type="submit" name="submit" value="Save changes" id="id-form-submit"/> 
		<input class="mdl-button mdl-js-button mdl-button--raised mL-16 mR-16" type="button" name="cancel" value="Cancel" id="id-form-cancel" onclick="location.href=&#39;/&#39;"/>
	</div>
</form>

<script>
$(document).ready(function(){
	
	function formatAuthor (author) {
	  if (!author.id) { return author.text; }
	  if (author.birth) {var b_str = '<span> Birth ' + author.birth + '</span>';}
	  else { var b_str = '';}
	  if (author.death) {var d_str = '<span> Death ' + author.death + '</span>';}
	  else { var d_str = '';}
	  var str = 
	    '<div><span>' + author.name + ' (' + author.name_en + ')</span>'
	    + '</div>'
	    + '<div class="fS-10px">' + b_str + d_str
	    + '</div>'	    
	  var $author = $(str);
	  return $author;
	};
	function formatAuthorSelection (author) {
	  console.log(author);
	  if (!author.id) { return author.text; }
	  if (!author.text) {
	  	  var $author = $(
	    	'<span>' + author.name + ' </span>'
	    	+ '<span>(' + author.name_en + ')</span>'
	  		);
	  } else {
		  var $author = $(
		    '<span>' + author.text + ' </span>'		    
		  );
	  }
	  return $author;
	};
		
    $("#id_author").select2({
      ajax: {
        url: "/p/search/author/",
        dataType: 'json',
        delay: 500,
        data: function (params) {
          return {
            q: params.term, // search term
          };
        },
        processResults: function (data, params) {
          // parse the results into the format expected by Select2
          // since we are using custom formatting functions we do not need to
          // alter the remote JSON data
          return {
            results: data,
          };
        },
        cache: true
      },
      theme: "classic",
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 3,
      templateResult: formatAuthor,
      templateSelection: formatAuthorSelection,
      placeholder: ""
    });
});
</script>